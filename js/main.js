
function init(){

function runProcessor(canvas, fillImg){  
  var pm = PixelManager(canvas);
  po('loaded image');

  po('searching for text bubbles...');
  var groups = pm.getContiguousWhite();
  po(groups.length + ' groups found')
  groups = pm.vetGroups(groups);
  po(groups.length + ' groups vetted');

  po('replacing text bubbles...');
  pm.replaceGroups(groups, fillImg);
  po('done!');

  var editedTag = document.getElementById('edited');
  var dataURL = canvas.toDataURL();
  editedTag.src = dataURL;
  $('#loading').hide();
}

function autoFill(canvas){
  $('#loading').show();
  $('#edited').attr('src', '#');
  var comicImg = new Image;
  comicImg.crossOrigin = "Anonymous";
  comicImg.onload = function() {
    canvas.width = comicImg.width;
    canvas.height = comicImg.height;
    canvas.getContext("2d").drawImage(comicImg, 0, 0);

    var fillImg = new Image;
    fillImg.crossOrigin = "Anonymous";
    fillImg.onload = function() {
      setTimeout(function (){
        runProcessor(canvas, fillImg);
      }, 1);
    };
    fillImg.src = fillSrc;
  };
  comicImg.src = comicSrc;
}

function loadImages(canvas){
  $('#loading').hide();
  $('#comic').attr('src', comicSrc);
  $('#fill').attr('src', fillSrc);

  // temp until bucket-fill
  // $('#autoFill').hide();
  // autoFill(canvas);
}

function handleImage(e, callback){
  var reader = new FileReader();
  reader.onload = function(event){
      callback(event.target.result);
  }
  reader.readAsDataURL(e.target.files[0]);
}

function loadComicDate(comicDate){
  var comicDateStr = comicDate.strftime("%Y-%m-%d");
  comicSrc = "https://s3.amazonaws.com/reddick/" + comicDateStr + ".gif";
  loadImages(canvas);
}

function readComicDate(){
  var comicDateStr = readUrlParam("date");
  if (comicDateStr){
    var s = comicDateStr.split('-');
    var comicDate = new Date(s[0], s[1]-1, s[2]);
    loadComicDate(comicDate);
  }
}

// on page load
var comicSrc = "img/sampleComic.gif";
var fillSrc = "img/sampleFill.png";
var canvas = document.getElementById("canvas");

var $datepicker = $("#datepicker");
$datepicker.datepicker({
  minDate: new Date(2014, 4, 28),
  maxDate: new Date(2016, 9, 20),
  // maxDate: 0 // 0 days from today
});
var comicDateStr = readUrlParam("date");
if (comicDateStr){
  var s = comicDateStr.split('-');
  var comicDate = new Date(s[0], s[1]-1, s[2]);
  $datepicker.datepicker('setDate', comicDate);
  loadComicDate(comicDate);
}

var imageLoader = document.getElementById('imageLoader');
imageLoader.addEventListener('change', function(e){
  handleImage(e, function(newcomicSrc){
    comicSrc = newcomicSrc;
    loadImages(canvas);
  });
}, false);
var fillLoader = document.getElementById('fillLoader');
fillLoader.addEventListener('change', function(e){
  handleImage(e, function(newFillSrc){
    fillSrc = newFillSrc;
    loadImages(canvas);
  });
}, false);

$datepicker.datepicker().on('change', function(){
  var comicDate = new Date($datepicker.datepicker('getDate'));
  window.history.pushState({}, "", "?date=" + comicDate.strftime("%Y-%m-%d"));
  readComicDate();
})

$(window).bind("popstate", readComicDate);  //Back button
$(window).bind("pushstate", readComicDate); //Forward button, OR window.history.pushState()

$('#autoFill').on('click', function(){
  autoFill(canvas);
});

loadImages(canvas);

}
